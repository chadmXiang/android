PackageManagerService
 packages.xml保存着所有安装应用的列表
packages.list 保存着非系统自带的应用

1.涉A涉G整改无法开机


问题背景是无法获取GMS更新后的应用，为了剥离对GMS应用的依赖，把GMS相关的应用移到另外的一个分区，系统在进行升级的时候，可以不依赖GMS应用的状态

getRequiredInstallerLPr



2.Line升级问题

在构造方法里面，做特殊处理，把line当系统应用处理，以最新的版本为准，就不用校验签名信息

从packages.xml里面读取了PackageSettingr后，针对line应用，做特殊处理，按系统应用的标准来进行处理，签名不一致的不会影响到正常安装


3.默认应用

preferedActivity  蓝牙音箱，启动了google voice

升级后，之前选择的默认未生效，因为能响应action的集合在变化，重新弹出选择









ActivityManagerService

三方应用播放默认铃声crash

RingtoneManager.getDefaultUri
getContentResolver().openInputStream()出现异常，calling uid和package不对应，权限拒绝

HwSettingsProvider进行了扩展，针对铃声做了一个专门的Helper类，来实现铃声的管理功能，在这个里面，把默认的context给改变了，使用了SettingProvider对应的context，调用应用是三方


chrome黑屏问题

chrome黑屏，进入freeform分屏模式后，用手势导航进入recent,然后退出到桌面，点击桌面chrome图标，出现黑屏
刚开始分析的时候，先dumpsys了Activity的信息，发现当前chrome界面的Activity宽和高都是-1，bouns都是0，从Log里面看，在手势进入Recent时，chrome的Activity没有走onPause 和 onStop，而是在下一次打开的时候才走onPause ，然后走到了OnResume里面，生命周期不正常

然后对比测试其它应用，用计算器试了下，在手势进入Recent时，计算器走到了onPause方法


找到了和正常情况的差异点后，在onPause的地方加log,看正常的是走到ActivityIdleInternalLocked，在Idle消息中完成onPause 和onStop的

    正常时，立即发送idle消息，而异常时，这里走的是scheduleIdleTimeoutLocked，没有立即发送idle消息


然后在代码里面找，走scheduleIdleTimeoutLocked和scheduleIdleLocked方法在哪一个判断条件里面触发的，找到了addToStopping方法

里面的idleDelayed变量值为true,进一步看此方法调用栈里面的上一步，makeInvisible里面传入的值，是根据应用是否支持pip来判断的，由于chrome支持pip,所以传入的值是true，对比计算器不支持pip，所以传入的是false

对比Google原生代码逻辑就是如此，为了让应用可以在OnPuase里面进入pip，给了一些延时给应用来处理，时间是10S，通过测试也可以确认，当下一次启动chrome的间隔超过10s，不会出现黑屏



问题的根因就在这个地方，对比测试其它支持pip的应用，也会出现这种问题


从整个调用栈来看，是从手动导航服务里面跨进程调用ActivityTaskManagerService里面的方法，设置ActivityRecord的可见性，最终走到了ActvityStack的makeInvisible方法

在最新的主干分支上，手势导航的逻辑重构了，没有此问题，在商用分支上，为了稳定性考虑，采用了退避方案处理，针对此种场景添加特殊处理，在checkEnterPictureInPictureState方法里面，针对出问题的场景的各种状态统一判断，在此场景下返回false，然后进行测试



调用到ActivityStack里面的makeInVisible方法，将当前ActivityRecord加入到Stopping列表里面，

RoleManagerService
roles.xml

system.xml
secure.xml
global.xml


ActivityManagerService

    chrome黑屏，makeInVisible

    AnxiFilter拦截,判断逻辑是top activity

PackageManagerService

    prets/pretvs 无法开机

    默认应用变化(升级后浏览器、语音唤醒默认apk都发生了变化)，修改默认应用

乐天line应用预置错误

CTS、GTS
NfcPanel问题
GTS INSTALL_PACKAGES权限整改，共用shareuid

Integer空指针导致黑屏,默认桌面，客户需求，华为对Configation进行了扩展，开机的时候会读取，由于

Felica适配：
（1）设置里面添加入口，提供打开关闭功能，和锁定功能
（2）SystemUI适配
（3）10几个apk,HCE 由客户提供，felicanetwork认证的4个apk找的第三方开发，jni/nci

语音唤醒：提供几个接口给客户应用，录入唤醒词，打开关闭功能，

SoftwareUpdate
     接口适配：(1)与服务器进行交互，检查是否有新版本，FOTA包有个配置文件，解析对应的文件
	 (2) 升级前检查，版本号检查、电量、空间，当前phone网络状态等
	（3）切FOTA 专用的apn，免流量的
   （4）包下载并保存，支持断点续传
   （5）与recovery联调，包路径和升级状态保存
   （6）压力测试FOTA稳定性

不能发送短信，收不到邮件问题攻关：wap push走的短信
system分区爆仓：


     



